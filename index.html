<html>

<head>
<meta charset="Shift_JIS">
<title>Commentor</title>
<script type="text/javascript" src="syntaxhighlighter_3.0.83/scripts/shCore.js"></script>
<script type="text/javascript" src="syntaxhighlighter_3.0.83/scripts/shBrushJScript.js"></script>
<link type="text/css" rel="stylesheet" href="syntaxhighlighter_3.0.83/styles/shCoreDefault.css"/>
<script type="text/javascript">

var lineNumberNodes;
var MutationObserver = window.MutationObserver || window.WebKitMutationObserver || window.MozMutationObserver;
var heightChangeObserver = new MutationObserver(mutationObjectCallback);
function mutationObjectCallback(mutations)
{
	var target = mutations[0].target;
	var searchClassName = target.className;
	var elements = $class(searchClassName);
	for (var i=0; i<elements.length; ++i) {
		if (elements[i] != target) {
			elements[i].style.setProperty("height", target.clientHeight + "px", "important");
		}
	}
}

$id = function (id) {
	return document.getElementById(id);
}

$class = function (className) {
	return document.getElementsByClassName(className);
}

function onCommentNodeKeyDown(e)
{
	if (e.keyCode == 9) {	// tab
		e.preventDefault();
		var tab = "&#09;";
		document.execCommand("InsertHTML", false, tab);
	}else if (e.keyCode == 27) {	// esc
		if (e.srcElement.innerText == "\n") {
			var comments = $class("comment number" + e.srcElement.lineNumber);
			e.srcElement.blur();
			var len = comments.length;
			for (var i=0; i<len; ++i) {
				comments[0].remove();
			}
		}
	}
}

function addCommentNode(lineNumber, desc)
{
	var newClassName = "comment number" + lineNumber;
	var exists = $class(newClassName);
	if (exists.length) {
		return;
	}
	var nodes = $class(lineNumberNodes[lineNumber-1].className);
	console.log("line number" + lineNumber);
	var config = {
		attributes: true,
		childList: true,
		characterData: true,
		subtree:true
	};
	for (var i=0; i<nodes.length; ++i) {
		var node = nodes[i];
		var nextNode = node.nextSibling;
		var div = document.createElement("div");
		div.className = newClassName;
		div.innerHTML = (i == 1) ? desc : "&nbsp;";
		div.lineNumber = lineNumber;
		console.log(node);
		node.appendChild(div);
		if (i == 1) {
			heightChangeObserver.observe(div, config);
			div.style.setProperty(
				"white-space", "pre"
			);
			div.style.setProperty(
				"color", "#000	", "important"
			);
			div.style.setProperty(
				"background-color", "#eee", "important"
			);
			div.style.setProperty(
				"padding", "6px", "important"
			);
			div.contentEditable = true;
			div.spellcheck = false;
			div.focus();
			div.blur();
			div.onkeydown = onCommentNodeKeyDown;
		}
	}
}

function onLineNumberNodeClick(e)
{
	var eventNode = e.toElement || e.originalTarget;
	addCommentNode(eventNode.lineNumber, "&#09;");
}

function saveComments()
{
	var comments = [];
	
	var nodes = $class("code")[0].querySelectorAll("div.comment");
	for (var i=0; i<nodes.length; ++i) {
		var node = nodes[i];
		comments.push({
			"line" : node.lineNumber,
			"desc" : node.innerHTML
		});
	}
	localStorage.setItem("comments", JSON.stringify(comments));
}

function addCommentNodes(comments)
{
	for (var i=0; i<comments.length; ++i) {
		var c = comments[i];
		addCommentNode(c.line, c.desc);
	}
}

function init()
{
	var gutter = $class("gutter")[0];
	var nodes = gutter.childNodes;
	lineNumberNodes = new Array(nodes.length);
	for (var i=0; i<nodes.length; ++i) {
		lineNumberNodes[i] = nodes[i];
	}
	for (var i=0; i<lineNumberNodes.length; ++i) {
		lineNumberNodes[i].lineNumber = i + 1;
		lineNumberNodes[i].onclick = onLineNumberNodeClick;
	}
	var saved = localStorage.getItem("comments");
	if (saved) {
		saved = JSON.parse(saved);
		addCommentNodes(saved);
	}
}

</script>

</head>
<body>

<button onclick="saveComments();">save</button>
<pre class="brush: js; toolbar: false;">
function helloSyntaxHighlighter()
{
	return "hi!";
}
</pre>

<script type="text/javascript">
SyntaxHighlighter.all();
setTimeout(function () {
	init();
}, 0)
</script>

</body>
</html>
