<html>

<head>
<meta charset="Shift_JIS">
<title>Commentor</title>
<script type="text/javascript" src="syntaxhighlighter_3.0.83/scripts/shCore.js"></script>
<script type="text/javascript" src="syntaxhighlighter_3.0.83/scripts/shBrushJScript.js"></script>
<script type="text/javascript" src="syntaxhighlighter_3.0.83/scripts/shBrushCpp.js"></script>
<link type="text/css" rel="stylesheet" href="syntaxhighlighter_3.0.83/styles/shCoreDefault.css"/>
<script type="text/javascript">

var lineNumberNodes;
var MutationObserver = window.MutationObserver || window.WebKitMutationObserver || window.MozMutationObserver;
var heightChangeObserver = new MutationObserver(mutationObjectCallback);
function mutationObjectCallback(mutations)
{
	var target = mutations[0].target;
	var searchClassName = target.className;
	var elements = $class(searchClassName);
	for (var i=0; i<elements.length; ++i) {
		if (elements[i] != target) {
			elements[i].style.setProperty("height", target.clientHeight + "px", "important");
		}
	}
}

$id = function (id) {
	return document.getElementById(id);
}

$class = function (className) {
	return document.getElementsByClassName(className);
}

function readFile(path)
{
	var xhr = new XMLHttpRequest();
	xhr.overrideMimeType('text/plain; charset=shift_jis');
	xhr.open('GET', path, false);
  	xhr.send(null);
  	return xhr.responseText;
}

function onCommentNodeKeyDown(e)
{
	if (e.keyCode == 9) {	// tab
		e.preventDefault();
		var tab = "&#09;";
		document.execCommand("InsertHTML", false, tab);
	}else if (e.keyCode == 27) {	// esc
		var elem = e.srcElement;
		var txt = elem.innerText;
		if (txt == "\n" || txt == "") {
			var comments = $class("comment number" + elem.lineNumber);
			var len = comments.length;
			for (var i=0; i<len; ++i) {
				comments[0].remove();
			}
		}
		elem.blur();
	}
}

function addCommentNode(lineNumber, desc)
{
	var newClassName = "comment number" + lineNumber;
	var exists = $class(newClassName);
	if (exists.length) {
		return;
	}
	var nodes = $class(lineNumberNodes[lineNumber-1].className);
	console.log("line number" + lineNumber);
	var config = {
		attributes: true,
		childList: true,
		characterData: true,
		subtree:true
	};
	for (var i=0; i<nodes.length; ++i) {
		var node = nodes[i];
		var nextNode = node.nextSibling;
		var div = document.createElement("div");
		div.className = newClassName;
		div.innerHTML = (i == 1) ? desc : "&nbsp;";
		div.lineNumber = lineNumber;
		console.log(node);
		node.appendChild(div);
		if (i == 1) {
			heightChangeObserver.observe(div, config);
			div.style.setProperty(
				"white-space", "pre"
			);
			div.style.setProperty(
				"color", "#000	", "important"
			);
			div.style.setProperty(
				"background-color", "#eee", "important"
			);
			div.style.setProperty(
				"padding", "6px", "important"
			);
			div.contentEditable = "plaintext-only";
			div.spellcheck = false;
			div.focus();
			div.blur();
			div.onkeydown = onCommentNodeKeyDown;
			return div;
		}
	}
}

function onLineNumberNodeClick(e)
{
	var eventNode = e.toElement || e.originalTarget;
	addCommentNode(eventNode.lineNumber, "").focus();
	
}

function saveComments()
{
	var comments = [];
	
	var nodes = $class("code")[0].querySelectorAll("div.comment");
	for (var i=0; i<nodes.length; ++i) {
		var node = nodes[i];
		comments.push({
			"line" : node.lineNumber,
			"desc" : node.innerHTML
		});
	}
	localStorage.setItem(getCurrentFileName(), JSON.stringify(comments));
}

function addCommentNodes(comments)
{
	for (var i=0; i<comments.length; ++i) {
		var c = comments[i];
		addCommentNode(c.line, c.desc);
	}
}

function getCurrentFileName()
{
	var sel = $id("select");
	return sel.childNodes[sel.selectedIndex].text;
}

function init()
{
	var filelist = readFile("filelist.txt").split("\r\n");
	var sel = $id("select");
	for (var i=0; i<filelist.length; ++i) {
		var filename = filelist[i];
		if (filename == "") {
			continue;
		}
		var opt = document.createElement("option");
		opt.text = filename;
		sel.appendChild(opt);
	}
	sel.onchange = function (e) {
		var idx = e.target.selectedIndex;
		if (!idx) {
			return;
		}
		localStorage.setItem("selectedIndex", idx);
		location.reload();
	}
	
	var idx = localStorage.getItem("selectedIndex");
	if (idx) {
		sel.selectedIndex = idx;
		var filename = filelist[idx-1];
		var src = readFile(filename);
		$id("src").innerText = src;
		setTimeout(function () {
			console.log(filename);
			var gutter = $class("gutter")[0];
			var nodes = gutter.childNodes;
			lineNumberNodes = new Array(nodes.length);
			for (var i=0; i<nodes.length; ++i) {
				lineNumberNodes[i] = nodes[i];
			}
			for (var i=0; i<lineNumberNodes.length; ++i) {
				lineNumberNodes[i].lineNumber = i + 1;
				lineNumberNodes[i].onclick = onLineNumberNodeClick;
			}
			var saved = localStorage.getItem(filename);
			if (saved) {
				saved = JSON.parse(saved);
				addCommentNodes(saved);
			}
		}, 100);
	}
}

window.onload = init;

</script>

</head>
<body>

<select id="select"><option>&nbsp;</option></select>
<button onclick="saveComments();">save</button>
<button onclick="saveComments();">save</button>
<br>


<pre id="src" class="brush: c; toolbar: false;"></pre>

<script type="text/javascript">SyntaxHighlighter.all();</script>

</body>
</html>
