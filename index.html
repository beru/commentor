<!DOCTYPE html>
<html>

<head>
<meta charset="Shift_JIS">
<title>Commentor</title>
<script type="text/javascript" src="lib/rainbow/rainbow.js"></script>
<script type="text/javascript" src="lib/rainbow/generic.js"></script>
<script type="text/javascript" src="lib/rainbow/c.js"></script>
<script type="text/javascript" src="lib/rainbow.linenumbers/rainbow.linenumbers.js"></script>
<link rel="stylesheet" type="text/css" href="lib/rainbow/obsidian.css" media="screen" />
<link rel="stylesheet" type="text/css" href="lib/rainbow.linenumbers/theme.css" media="screen" />
<script type="text/javascript">

$id = function (id) {
	return document.getElementById(id);
}

$class = function (className) {
	return document.getElementsByClassName(className);
}

function onCommentNodeKeyDown(e)
{
	if (e.keyCode == 9) {	// tab
		e.preventDefault();
		var tab = "&#09;";
		document.execCommand("InsertHTML", false, tab);
	}else if (e.keyCode == 27) {	// esc
		var elem = e.srcElement || e.target;
		var txt = elem.innerText;
		if (txt == "\n" || txt == "") {
			elem.remove();
		}else {
			elem.blur();
		}
	}
}

function supportsPlainText()
{
    var d = document.createElement("div");
    try {
        d.contentEditable="PLAINtext-onLY";
    } catch(e) {
        return false;
    }
    return d.contentEditable=="plaintext-only";
}

function addCommentNode(lineNumberNode, desc)
{
	var nextNode = lineNumberNode.nextSibling;
	var div = document.createElement("div");
	div.innerHTML = desc;
	nextNode.appendChild(div, nextNode);
	with (div.style) {
		setProperty(
			"color", "#ee3"
		);
		setProperty(
			"background-color", "#024"
		);
		setProperty(
			"font-weight", "bold"
		);
		setProperty(
			"white-space", "pre"
		);
		setProperty(
			"tab-size", "4"
		);
	}
	div.className = "code-comment";
	if (supportsPlainText()) {
		div.contentEditable = "plaintext-only";
	}else {
		div.contentEditable = true;
	}
	div.spellcheck = false;
	if (desc == "") {
		div.focus();
		div.blur();
	}
	div.onkeydown = onCommentNodeKeyDown;
	return div;
}

function addCommentNodes(comments)
{
	for (var i=0; i<comments.length; ++i) {
		var c = comments[i];
		addCommentNode(lineNumberNodes[Number(c.line) - 1], c.desc);
	}
}

function onLineNumberNodeClick(e)
{
	var eventNode = e.toElement || e.originalTarget;
	
	if (eventNode.nextSibling.lastChild.className == "code-comment") {
		eventNode.nextSibling.lastChild.focus();
	}else {
		addCommentNode(eventNode, "").focus();
	}
}

function saveComments()
{
	var comments = [];
	var nodes = $class("rainbow")[0].querySelectorAll("div.code-comment");
	for (var i=0; i<nodes.length; ++i) {
		var node = nodes[i];
		comments.push({
			"line" : Number(node.parentNode.previousSibling.dataset.lineNumber),
			"desc" : node.innerText || node.textContent
		});
	}
	localStorage.setItem(fileName, JSON.stringify(comments));
}

var lineNumberNodes;
var fileName;

function output(src)
{
	var html = "";
	html += '<button onclick="saveComments();">save</button>';
	html += '<br>';
	html += '<pre id="src" style="tab-size: 4;">';
	html += '<code data-language="c">';
	if (fileName) {
		html += src;
	}
	html += '</code>';
	html += '</pre>';
	$id("dropbox").innerHTML = html;
	Rainbow.color();
	setup();
}

function setup()
{
	var saved = localStorage.getItem(fileName);
	var nodes = $id("src").firstChild.firstChild.childNodes;
	lineNumberNodes = new Array(nodes.length);
	for (var i=0; i<nodes.length; ++i) {
		lineNumberNodes[i] = nodes[i].firstChild;
		lineNumberNodes[i].onclick = onLineNumberNodeClick;
	}
	if (saved) {
		saved = JSON.parse(saved);
		addCommentNodes(saved);
	}
}

function cancelEvent(e)
{
	e.preventDefault();
	e.stopPropagation();
	return false;
}

function drop(e) {
	e.stopPropagation();
	e.preventDefault();

	var dt = e.dataTransfer;
	var files = dt.files;
	fileName = files[0].name;
	document.title = fileName;
    var reader = new FileReader();
    reader.onloadend = function(evt) {
        output( evt.target.result );
    };
    reader.readAsText(files[0], "sjis");
}

window.onload = function() {
	var dropbox;
	dropbox = document.getElementById("dropbox");
	dropbox.addEventListener("dragenter", cancelEvent, false);
	dropbox.addEventListener("dragover", cancelEvent, false);
	dropbox.addEventListener("drop", drop, false);
}

</script>

</head>
<body style="background-color:black; padding:0px; margin:0px;">

<div id="dropbox" style="color:white; position:absolute; width:100%; height:100%;">ここにドロップしたファイルを読み込みます。</div>

</body>
</html>
