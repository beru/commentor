<!DOCTYPE html>
<html>

<head>
<meta charset="Shift_JIS">
<title>Commentor</title>
<script type="text/javascript" src="lib/rainbow/rainbow.js"></script>
<script type="text/javascript" src="lib/rainbow/generic.js"></script>
<script type="text/javascript" src="lib/rainbow/c.js"></script>
<script type="text/javascript" src="lib/rainbow.linenumbers/rainbow.linenumbers.js"></script>
<link rel="stylesheet" type="text/css" href="lib/rainbow/obsidian.css" media="screen" />
<link rel="stylesheet" type="text/css" href="lib/rainbow.linenumbers/theme.css" media="screen" />
<script type="text/javascript">

$id = function (id) {
	return document.getElementById(id);
}

$class = function (className) {
	return document.getElementsByClassName(className);
}

function readFile(path)
{
	var xhr = new XMLHttpRequest();
	xhr.overrideMimeType('text/plain; charset=shift_jis');
	xhr.open('GET', path, false);
  	xhr.send(null);
  	return xhr.responseText;
}

function onCommentNodeKeyDown(e)
{
	if (e.keyCode == 9) {	// tab
		e.preventDefault();
		var tab = "&#09;";
		document.execCommand("InsertHTML", false, tab);
	}else if (e.keyCode == 27) {	// esc
		var elem = e.srcElement;
		var txt = elem.innerText;
		if (txt == "\n" || txt == "") {
			elem.remove();
		}else {
			elem.blur();
		}
	}
}

function addCommentNode(lineNumberNode, desc)
{
	var nextNode = lineNumberNode.nextSibling;
	var div = document.createElement("div");
	div.innerHTML = desc;
	nextNode.appendChild(div, nextNode);
	with (div.style) {
		setProperty(
			"color", "#ee3"
		);
		setProperty(
			"background-color", "#024"
		);
		setProperty(
			"white-space", "pre"
		);
		setProperty(
			"tab-size", "4"
		);
	}
	div.className = "code-comment";
	div.contentEditable = "plaintext-only";
	div.spellcheck = false;
	if (desc == "") {
		div.focus();
		div.blur();
	}
	div.onkeydown = onCommentNodeKeyDown;
	return div;
}

function addCommentNodes(comments)
{
	for (var i=0; i<comments.length; ++i) {
		var c = comments[i];
		addCommentNode(lineNumberNodes[Number(c.line) - 1], c.desc);
	}
}

function onLineNumberNodeClick(e)
{
	var eventNode = e.toElement || e.originalTarget;
	
	if (eventNode.nextSibling.lastChild.className == "code-comment") {
		eventNode.nextSibling.lastChild.focus();
	}else {
		addCommentNode(eventNode, "").focus();
	}
}

function saveComments()
{
	var comments = [];
	
	var nodes = $class("rainbow")[0].querySelectorAll("div.code-comment");
	for (var i=0; i<nodes.length; ++i) {
		var node = nodes[i];
		comments.push({
			"line" : Number(node.parentNode.previousSibling.dataset.lineNumber),
			"desc" : node.innerText
		});
	}
	localStorage.setItem(fileName, JSON.stringify(comments));
}

var lineNumberNodes;
var fileName;
var filelist = readFile("filelist.txt").split("\r\n");
var selIdx = localStorage.getItem("selectedIndex");
if (selIdx) {
	fileName = filelist[selIdx - 1];
	output();
}

function output()
{
	var html = "";
	html += '<select id="select"><option>&nbsp;</option></select>';
	html += '<button onclick="saveComments();">save</button>';
	html += '<br>';
	html += '<pre id="src" style="tab-size: 4;">';
	html += '<code data-language="c">';
	if (fileName) {
		html += readFile(fileName);
	}
	html += '</code>';
	html += '</pre>';
	document.write(html);
}

document.addEventListener('DOMContentLoaded', function () {
	var sel = $id("select");
	sel.onchange = function (e) {
		var selIdx = e.target.selectedIndex;
		if (!selIdx) {
			return;
		}
		localStorage.setItem("selectedIndex", selIdx);
		location.reload();
	}
	for (var i=0; i<filelist.length; ++i) {
		var fname = filelist[i];
		if (fname == "") {
			continue;
		}
		var opt = document.createElement("option");
		opt.text = fname;
		sel.appendChild(opt);
	}
	sel.selectedIndex = selIdx;
	var saved = localStorage.getItem(fileName);
	var nodes = $id("src").firstChild.firstChild.childNodes;
	lineNumberNodes = new Array(nodes.length);
	for (var i=0; i<nodes.length; ++i) {
		lineNumberNodes[i] = nodes[i].firstChild;
		lineNumberNodes[i].onclick = onLineNumberNodeClick;
	}
	if (saved) {
		saved = JSON.parse(saved);
		addCommentNodes(saved);
	}
});

</script>

</head>
<body style="background-color:#000">

</body>
</html>
